---
title: "Analysis of PQA-VS Indicator 13 - Paraná, Brazil"
author: "Diego Spinoza dos Santos"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: cerulean
    highlight: tango
    toc: true
    toc_float: true
    number_sections: false
# ---
# ALTERNATIVE OUTPUT TO WORD (using a template)
# To generate the report in Word, comment out the 'html_document' section above
# and uncomment the 'word_document' section below.
# Make sure the 'modelo_rmarkdown.docx' file is in the same folder.
# ---
#  word_document:
#    reference_docx: modelo_rmarkdown.docx
---

```{r include=FALSE}
# Course: Data Visualization and Analysis with R Software
# Applied to Health Surveillance
# Program for Strengthening Epidemiology in Health Services - PROFEPI

# Author: Diego Spinoza dos Santos
# Note: This code is accompanied by a recorded video lecture (in Portuguese with subtitles)
# available at: <https://www.youtube.com/watch?v=hG0neJ1tiQo>



# Module 1 - Analysis of PQA-VS Indicator 13

# Loading required packages ------------------------------------

library(rio)        # Package for reading files
library(tidyverse)  # Package for data manipulation
library(janitor)    # Package for data manipulation


# Loading the datasets for analysis ----------------------------

ac_mat_biologico <- import("DADOS/ACD_MATBIO_PROFEPI_NOVO.dbf")

ac_trabalho <- import("DADOS/ACD_TRAB_PROFEPI_NOVO.dbf")

intox_exogena <- import("DADOS/INTOX_EXOG_PROFEPI_NOVO.dbf")

cnae <- import("DADOS/CNAENET.dbf")

cbo <- import("DADOS/OCUPANET.dbf")


# Indicator 13 ------------------------------------------------------------


# Proportion of completeness for the "Occupation" and "Economic Activity (CNAE)" fields
# in notifications of work-related accidents,
# work-related accidents with exposure to biological material, and
# work-related exogenous poisoning, by municipality of notification.


# Identifying work-related poisonings ---------------------

# For this indicator, only poisoning notifications where the field 
# DOENCA_TRA is marked as "1" (Yes) are considered.


intox_exogena_trabalho <- intox_exogena |>
  filter(DOENCA_TRA == "1")


# Join the datasets to calculate the indicator ------------------

# To join the datasets, it's important that the variables are the same.
# Selecting the variables of interest for the indicator calculation.
# For this, we will create objects with the same variables.



acmatbio_indicador <- ac_mat_biologico |> 
  select(ID_AGRAVO, DT_NOTIFIC,
         SG_UF_NOT, ID_MUNICIP, ID_REGIONA, 
         ID_MN_RESI, ID_RG_RESI,
         SIT_TRAB, ID_OCUPA_N, CNAE)

actrab_indicador <- ac_trabalho |> 
  select(ID_AGRAVO, DT_NOTIFIC,
         SG_UF_NOT, ID_MUNICIP, ID_REGIONA,
         ID_MN_RESI, ID_RG_RESI,
         SIT_TRAB, ID_OCUPA_N, CNAE)

intoxexogen_indicador <- intox_exogena_trabalho |>
  select(ID_AGRAVO, DT_NOTIFIC,
         SG_UF_NOT, ID_MUNICIP, ID_REGIONA,
         ID_MN_RESI, ID_RG_RESI,
         SIT_TRAB, ID_OCUPA_N, CNAE)

# Binding datasets

indicador_13 <- bind_rows(acmatbio_indicador,
                          actrab_indicador,
                          intoxexogen_indicador)

# Assigning names to CBO and CNAE codes --------------------
# For this operation, we will perform table joins.

# Incorporating the occupation names (CBO)

indicador_13 <- left_join(indicador_13, cbo,
                          by = "ID_OCUPA_N")

# Incorporating the economic activity names (CNAE)

indicador_13 <- left_join(indicador_13, cnae,
                          by = c("CNAE" = "CLASS_CNAE"))

# Fixing character encoding issues

library(stringi) # package for string manipulation

# Convert the NM_OCUPACA column from CP850 to UTF-8 encoding

indicador_13$NM_OCUPACA <- stri_encode(indicador_13$NM_OCUPACA,
                                       from = "CP850", to = "UTF-8")

# Indicator Calculation ----------------------------------------------------

# We need to remember that the indicator refers to the municipality of notification.
# In this case, we only want notifications from the state being evaluated, PR
# Let's filter the dataset to ensure this condition is met.
# We will apply filter() to the SG_UF_NOT variable.

indicador13_pr <- indicador_13 |> 
  filter(SG_UF_NOT == "41")

# If you are analyzing a specific municipality, you can filter by the ID_MUNICIP column
# using your municipality's code.

# Example:
# indicador13_curitiba <- indicador_13 |> filter(ID_MUNICIP == "410690")

# Calculation method
# Step 1

# Calculate the completeness proportion for the "Occupation" field:
# Numerator: Number of notifications with the "Occupation" field
# filled according to the corresponding CBO codes.
# Denominator: Total number of notifications for the health conditions,
# in a given year and municipality of notification.

# IMPORTANT, the following CBO codes should not be included in the numerator:

# "XXX - Not informed",
# "000000 - CBO undefined", and
# "998999 - Ignored"

# Checking the CBO codes present in our dataset

cbo_informados <- indicador13_pr |> 
  group_by(ID_OCUPA_N) |>
  summarise(NOTIFICACOES = n())
cbo_informados

# Excluding invalid CBO codes directly from the dataset
# and excluding empty/NA fields

indicador13_cbo_validos <- indicador13_pr |>
  filter(!ID_OCUPA_N %in% c("XXX",
                            "000000",
                            "998999")) |>
  filter(!is.na(ID_OCUPA_N)) # not empty

# Storing the values in objects 

numerador_indicador13a <- nrow(indicador13_cbo_validos)
numerador_indicador13a

denominador_indicador13 <- nrow(indicador13_pr)
denominador_indicador13

# Step 1 Calculation

indicador13a <- (numerador_indicador13a / denominador_indicador13)
indicador13a

# Calculation method
# Step 2

# Completeness proportion for the "Economic Activity" field:
# Numerator: Number of notifications with the "Economic Activity"
# field filled according to the CNAE codes.
# Denominator: Total number of notifications.

indicador13_cnae_validos <- indicador13_pr |>
  filter(!is.na(CNAE)) # not empty

numerador_indicador13b <- nrow(indicador13_cnae_validos)
numerador_indicador13b

# Step 2 calculation

indicador13b <- (numerador_indicador13b / denominador_indicador13)
indicador13b

# Step 3 calculation

# Average of the completeness proportions obtained for the
# "Occupation" and "Economic Activity" fields.

indicador13_final <- ((indicador13a + indicador13b) / 2) * 100
indicador13_final

# Indicator Targets/Goals
# For 2023: >= 60% of qualified completeness
# For 2024: >= 75% of qualified completeness
# For 2025: >= 90% of qualified completeness

# End of the calculation for PQA-VS Indicator 13


# Formatting a table for export ------------------------------------

# We will work with the indicator information for CBO and CNAE,
# distributed by health regions. This way, we can indicate to managers
# if there are areas for action by the Worker's Health Surveillance
# to improve the quality of notifications.

# Creating flag variables to assess CBO and CNAE information

# Assessing CBO

# "XXX - Not informed",
# "000000 - CBO undefined", and
# "998999 - Ignored"

# Create a REGEX for invalid CBOs

cbo_invalido <- c("XXX","000000", "998999")
cbo_invalido <- str_c(cbo_invalido, collapse = "|")
cbo_invalido

# Create a variable to assess CBO completeness

indicador13_pr <- indicador13_pr |>
  mutate(cbo_adequado = if_else(
    is.na(ID_OCUPA_N)| str_detect(ID_OCUPA_N, cbo_invalido),
    "Inadequado",
    "Adequado"))

# Assessing CNAE completeness

indicador13_pr <- indicador13_pr |>
  mutate(cnae_adequado = if_else(
    is.na(CNAE),
    "Inadequado",
    "Adequado"))

# Verifying the results found previously

resumo_cbo <- indicador13_pr |>
  group_by(cbo_adequado) |>
  summarise(notificacoes = n())

resumo_cnae <- indicador13_pr |>
  group_by(cnae_adequado) |>
  summarise(notificacoes = n())

# Results OK

# Now let's group by health regions

# Step 1: count notifications by health region

notificacoes_regionais <- indicador13_pr |>
  group_by(ID_REGIONA) |>
  summarise(notificacoes = n())

# Step 2: count adequate CBO notifications by health region

cbo_adequado_regionais <- indicador13_pr |>
  filter(cbo_adequado == "Adequado") |> 
  group_by(ID_REGIONA) |>
  summarise(cbo_adequado = n())

# Step 3: count adequate CNAE notifications by health region

cnae_adequado_regionais <- indicador13_pr |>
  filter(cnae_adequado == "Adequado") |> 
  group_by(ID_REGIONA) |>
  summarise(cnae_adequado = n())

# Step 4: join the information

ind13_regionais <- left_join(notificacoes_regionais,
                             cbo_adequado_regionais,
                             by = "ID_REGIONA")

ind13_regionais <- left_join(ind13_regionais,
                             cnae_adequado_regionais,
                             by = "ID_REGIONA")

# Step 5: For the calculation, we need to replace NAs with 0

ind13_regionais <- ind13_regionais |>
  mutate(cnae_adequado = replace_na(cnae_adequado, 0))

# Step 6: calculate the indicator for each region

ind13_regionais <- ind13_regionais |>
  mutate(indicador13 = ((cbo_adequado/notificacoes) +
                          (cnae_adequado/notificacoes))/2*100)

# Step 7: Let's name the regions

# For this, we need the table with the region names

regionais <- import("DADOS/REGIONET.dbf")

# Join the tables

ind13_regionais <- left_join(ind13_regionais,
                             regionais,
                             by = "ID_REGIONA")

# Step 8: Select and rename columns of interest

ind13_regionais <- ind13_regionais |>
  select(NM_REGIONA, cbo_adequado, cnae_adequado,
         notificacoes, indicador13) |>
  rename("Regional de saúde" = "NM_REGIONA",
         "CBO Adequado" = "cbo_adequado",
         "CNAE Adequado" = "cnae_adequado",
         "Notificações" = "notificacoes",
         "Indicador 13" = "indicador13")
ind13_regionais

# Step 9: Format a table

library(gt) # Package for table formatting


indicador13_gt <- ind13_regionais |>
  gt() |> # assign gt format
  tab_header( # assig a title
    title = md("**Indicador 13, PQA-VS, segundo Regional de Saúde de Notificação, Paraná, Brasil, 2022**")
  ) |> 
  tab_style(                          # Table style
    style = cell_text(weight = "bold"), # bold
    locations = cells_column_labels(everything())
  ) |> 
  cols_align(       # Column alignment
    align = "center", # center-align columns
    columns = c(2, 3, 4, 5) # defines columns
  ) |>
  fmt_number(
    columns = c(5),  # Format a specific column
    sep_mark = ".",  # Thousands separator
    dec_mark = ",",  # Decimal mark
    decimals = 1     # Digits
  ) |>
  tab_footnote(
    footnote = "Nota: Meta de 60% para CBO e CNAE corretamente preenchidos",
    locations = cells_title(groups = "title")) |> # Add the footnote indicator
  tab_style(
    style = cell_text(weight = "bold"),  # Apply bold
    locations = cells_body(
      columns = everything(),  # All columns
      rows = which(ind13_regionais[[5]] >= 60)  # Condition to apply bold
    )) |> 
  tab_options(
    table.font.size = "small"
  )

indicador13_gt


###############################################################################


# Module 2 ----------------------------------------------------------------

# Course: Data Visualization and Analysis with R Software
# Applied to Health Surveillance and Environment
# Program for Strengthening Epidemiology in Health Services - PROFEPI

# Module 2 - Creating a chart for PQA-VS Indicator 13

# Create vectors with region codes for each macro-region
# Using the REGEX we've already learned

leste <- "^01|^02|^03|^04|^05|^06|^21"
oeste <- "^07|^08|^09|^10|^20"
norte <- "^16|^17|^18|^19|^22"
noroeste <- "^11|^12|^13|^14|^15"



# Create the macro-region variable

ind13_regionais <- ind13_regionais |>
  mutate(macro = case_when(
    str_detect(`Regional de saúde`, leste) ~ "Leste",
    str_detect(`Regional de saúde`, oeste) ~ "Oeste",
    str_detect(`Regional de saúde`, norte) ~ "Norte",
    str_detect(`Regional de saúde`, noroeste) ~ "Noroeste"))

# Create a summary by macro-region

ind13_macro <- ind13_regionais |> 
  group_by(macro) |>
  summarise(cbo_adequado = sum(`CBO Adequado`),
            cnae_adequado = sum(`CNAE Adequado`),
            notificacoes = sum(Notificações)) |>
  mutate(ind13 = (((cbo_adequado/notificacoes) +
                     (cnae_adequado/notificacoes))/2*100))


# Create chart by health macro-region ---------------------------------


# Bar chart with a reference line for the indicator's target

ggplot(ind13_macro,                  # Data source
       aes(x = macro,                # X-axis variable (macro-regions)
           y = ind13,                # Y-axis variable (values of the variable)
           fill = macro)) +          # Colors for the macro-regions
  
  geom_bar(                          # Define the bar geometry (geom_bar)
    stat = "identity",        # Use the variable's values for the bar height
    width = 0.6,              # Define the bar width (60%)
    color = "black") +        # Define the bar outline color
  
  geom_hline(                        # Add the target line
    yintercept = 60,        # Position the line at 60 (target)
    linetype = "dashed",    # Define the line as dashed
    color = "red",          # Define the line colcor
    linewidth = 1) +        # Define the line width
  
  annotate(                          # Add a annotation to the chart (target)
    "text",                   # Define annotation as a text
    x = 4.5,                  # Text position, near the end of the X-axis
    y = 60,                   # Text position on the Y-axis, on the line (60)
    label = "Meta indicador", # Define the annotation text  
    color = "black",          # Text color
    hjust = 1,                # Right-aling the text
    vjust = -0.5,             # Space the text to be just above the line
    size = 5) +               # Font size
  
  labs(                              # Define chart title and labels
    title = "Desempenho por Macroregião, Indicador 13 - PQA-VS, PR, 2022",
    x = "Macroregião",            # X and Y axis labels
    y = "Proporção de notificações preenchidas adequadamente",
    fill = "Macrorregiões") +
  scale_fill_manual(                 # Manually define the column colors
    # Define the macro-regions color
    values = c("Norte"    = "#fc8d59",      
               "Oeste"    = "#fee08b", 
               "Noroeste" = "#91cf60", 
               "Leste"    = "#1a9850")) +
  
  theme_minimal() +                  # Apply the minimal theme
  
  theme(legend.position = "none")    # Hide the chart legend


# Module 2 ----------------------------------------------------------------

# Course: Data Visualization and Analysis with R Software
# Applied to Health Surveillance and Environment
# Program for Strengthening Epidemiology in Health Services - PROFEPI

# Module 2 - Creating a map for PQA-VS Indicator 13


# Create map with the number of notifications by municipality ---------------------

# Load municipality data from the SINAN table, filtering for PR

municipios_pr <- import("DADOS/MUNICNET.dbf") |>
  filter(SG_UF == "PR")

# Joining the indicator table with the municipality table

indicador13_pr <- indicador13_pr |> 
  left_join(municipios_pr,
            by = c("ID_REGIONA",
                   "ID_MUNICIP"))

# Loading the IBGE municipality shapefile into R
# For this, we need the {sf} package

# Load the {sf} package, if not installed,
# install it with install.packages("sf")

library(sf)

# Reading the shapefile with the st_read function

mapa_municipios <- st_read("DADOS/PR_Municipios_2022.shp")

# Adjusting the municipality codes to have 6 digits for the join

mapa_municipios <- mapa_municipios |> 
  mutate(COD6DIG = str_sub(CD_MUN, 1, 6))

# Joining the maps (shapefile) with the notification data, using the code

mapa_municipios <- mapa_municipios |> 
  left_join(indicador13_pr,
            by = c("COD6DIG" = "ID_MUNICIP"))

# Creating a dataset with the number of notifications by municipality
# Summarizing notifications to one row per municipality

notificacoes_municipios <- mapa_municipios |>
  group_by(NM_MUN, COD6DIG, geometry) |>
  summarise(notificacoes = n())

# Adequate CBO by municipality
# Identifying only notifications with adequate CBO

municipio_cbo <- indicador13_pr |>
  filter(cbo_adequado == "Adequado") |> 
  group_by(ID_MUNICIP) |>
  summarise(cbo_adequado = n())

# Adequate CNAE by municipality
# Identifying only notifications with adequate CNAE

municipio_cnae <- indicador13_pr |>
  filter(cnae_adequado == "Adequado") |> 
  group_by(ID_MUNICIP) |>
  summarise(cnae_adequado = n())

# Join datasets

# Joining notifications and CBO information 

notificacoes_municipios <- notificacoes_municipios |>
  left_join(municipio_cbo,
            by = c("COD6DIG" = "ID_MUNICIP"))

# Joining the previous dataset and CNAE information

notificacoes_municipios <- notificacoes_municipios |>
  left_join(municipio_cnae,
            by = c("COD6DIG" = "ID_MUNICIP"))

# Adjusting the final dataset and calculating the indicator for each municipality
# removing NA values to perform the indicator calculations

notificacoes_municipios <- notificacoes_municipios |>
  replace_na(list(notificacoes = 0,
                  cbo_adequado = 0,
                  cnae_adequado = 0)) |>
  mutate(ind13 = (((cbo_adequado/notificacoes) +
                     (cnae_adequado/notificacoes))/2*100))

# Create a categorization of percentages based on the indicator

# Indicator Targets/Goals
# For 2023: >= 60% of qualified completeness
# For 2024: >= 75% of qualified completeness
# For 2025: >= 90% of qualified completeness

notificacoes_municipios <- notificacoes_municipios |>
  mutate(meta_ind13 = case_when(ind13 < 60 ~ "Não atingiu",
                                ind13 >= 60 & ind13 < 75 ~ "Meta 2023",
                                ind13 >= 75 & ind13 < 90 ~ "Meta 2024",
                                ind13 >= 90 ~ "Meta 2025"))


# Map with targets by municipality


ggplot(data = notificacoes_municipios, # Data source
       aes(fill = meta_ind13)) +       # Map fill variable
  # In this case, X and Y are the coordinates
  geom_sf() +                          # Define the sf map geometry
  theme_minimal()+                     # Apply the minimal theme
  # Define the title and labels
  labs(title = "Metas do Indicador 13, PQA-VS, PR, 2022",
       subtitle = "Proporção de preenchimento dos campos “Ocupação” e “Atividade Econômica (CNAE)”",
       fill = "Metas indicador") +
  # Manually define the colors
  scale_fill_manual(values = c("Não atingiu" = "#f6e8c3", 
                               "Meta 2023"   = "#ccece6", 
                               "Meta 2024"   = "#41ae76", 
                               "Meta 2025"   = "#005824"))


####################################################

# Module 3 - Report Building -------------------------------------

# Course: Data Visualization and Analysis with R Software
# Applied to Health Surveillance and Environment
# Program for Strengthening Epidemiology in Health Services - PROFEPI

# Module 3 - Creating a report for PQA-VS Indicator 13




```
## About the PQA-VS Program

The **Health Surveillance Actions Qualification Program (PQA-VS)** represents a milestone for Health Surveillance in Brazil by defining commitments and responsibilities for the three spheres of government: federal, state, and municipal. It aims to encourage the implementation of initiatives that ensure the improvement of health surveillance actions.

**Indicators:** The indicators established in the program were selected based on their relevance to the National Health Surveillance and Environment System. Together, they provide an overview of the main actions of Health Surveillance, highlighting potential strengths to be explored or obstacles to their full realization.


## Results for Indicator 13 - Paraná, 2022

The following sections present the results for Indicator 13 for the health regions of Paraná in the year 2022.

```{r echo=FALSE}
indicador13_gt
```

### Indicator 13 by Macro-Region

The following chart shows the performance of the health macro-regions of Paraná and their achievement in relation to the target for PQA-VS Indicator 13.


```{r echo=FALSE}
ggplot(ind13_macro,                  # Data source
       aes(x = macro,                # X-axis variable (macro-regions)
           y = ind13,                # Y-axis variable (values of the variable)
           fill = macro)) +          # Colors for the macro-regions
  
  geom_bar(                          # Define the bar geometry (geom_bar)
    stat = "identity",        # Use the variable's values for the bar height
    width = 0.6,              # Define the bar width (60%)
    color = "black") +        # Define the bar outline color
  
  geom_hline(                        # Add the target line
    yintercept = 60,        # Position the line at 60 (target)
    linetype = "dashed",    # Define the line as dashed
    color = "red",          # Define the line colcor
    linewidth = 1) +        # Define the line width
  
  annotate(                          # Add a annotation to the chart (target)
    "text",                   # Define annotation as a text
    x = 4.5,                  # Text position, near the end of the X-axis
    y = 60,                   # Text position on the Y-axis, on the line (60)
    label = "Meta indicador", # Define the annotation text  
    color = "black",          # Text color
    hjust = 1,                # Right-aling the text
    vjust = -0.5,             # Space the text to be just above the line
    size = 5) +               # Font size
  
  labs(                              # Define chart title and labels
    title = "Desempenho por Macroregião, Indicador 13 - PQA-VS, PR, 2022",
    x = "Macroregião",            # X and Y axis labels
    y = "Proporção de notificações preenchidas adequadamente",
    fill = "Macrorregiões") +
  scale_fill_manual(                 # Manually define the column colors
    # Define the macro-regions color
    values = c("Norte"    = "#fc8d59",      
               "Oeste"    = "#fee08b", 
               "Noroeste" = "#91cf60", 
               "Leste"    = "#1a9850")) +
  
  theme_minimal() +                  # Apply the minimal theme
  
  theme(legend.position = "none")    # Hide the chart legend
```

### Indicator 13 Map by Municipality

The map below presents the performance of the indicator by municipality in Paraná and whether each city met the defined target according to the parameters set by the Ministry of Health.


```{r echo=FALSE}
ggplot(data = notificacoes_municipios, # Data source
       aes(fill = meta_ind13)) +       # Map fill variable
  # In this case, X and Y are the coordinates
  geom_sf() +                          # Define the sf map geometry
  theme_minimal()+                     # Apply the minimal theme
  # Define the title and labels
  labs(title = "Metas do Indicador 13, PQA-VS, PR, 2022",
       subtitle = "Proporção de preenchimento dos campos “Ocupação” e “Atividade Econômica (CNAE)”",
       fill = "Metas indicador") +
  # Manually define the colors
  scale_fill_manual(values = c("Não atingiu" = "#f6e8c3", 
                               "Meta 2023"   = "#ccece6", 
                               "Meta 2024"   = "#41ae76", 
                               "Meta 2025"   = "#005824"))


```

